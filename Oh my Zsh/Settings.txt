# ========================
# Terminal & Title Config
# ========================
export TERMINAL="xterm-256color"
export DISABLE_AUTO_TITLE="true"

# ========================
# History Configuration (must be before Oh My Zsh)
# ========================
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
HIST_STAMPS="yyyy-mm-dd"
setopt HIST_VERIFY              # Show command with history expansion before running
setopt SHARE_HISTORY            # Share history between sessions
setopt HIST_IGNORE_DUPS         # Don't record duplicates
setopt HIST_IGNORE_ALL_DUPS     # Delete old recorded entry if new entry is a duplicate
setopt HIST_FIND_NO_DUPS        # Do not display a line previously found
setopt HIST_IGNORE_SPACE        # Don't record commands starting with space
setopt HIST_SAVE_NO_DUPS        # Don't write duplicate entries
setopt HIST_REDUCE_BLANKS       # Remove superfluous blanks

# ========================
# Oh My Zsh Setup
# ========================
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"

plugins=(git docker npm zsh-autosuggestions zsh-completions zsh-syntax-highlighting)
source $ZSH/oh-my-zsh.sh

# Set terminal title after Oh My Zsh loads
print -Pn "\e]0;üíª  Praveen Singh\a"

# ========================
# Aliases
# ========================

# --- File & Navigation ---
alias ls='eza -la --icons'
alias cls='clear'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -'    # go back to previous dir
alias c.='code .'  # open VS Code
alias cr='cursor .' # open cursor
alias bat="batcat"
alias ll='eza -l --icons'
alias tree='eza --tree --icons'
alias md='mkdir -p'
alias rd='rm -rf'
alias f='find . -type f -name'     # usage: f "*.js"
alias d='find . -type d -name'     # usage: d "components"
alias reload='source ~/.zshrc'     # reload zsh quickly
alias ..2='cd ../../'
alias ..3='cd ../../../'
alias sz='source ~/.zshrc'
alias paths='echo $PATH | tr ":" "\n"'
alias usage='du -sh *'   # show folder sizes
alias whichp='which -a'  # show all executable paths


# --- Git Shortcuts ---
# Git aliases - optimized & switch-friendly

# basic
alias gs='git status'
alias gss='git status -s'
alias gl='git log --oneline --graph --decorate --all'
alias gshow='git show'
alias gdiff='git diff'
alias gstats='git diff --stat'

# add / commit / amend
alias ga='git add .'                 # add all new/modified (same as before)
alias gau='git add -u'               # update tracked files only
alias gamend='git commit --amend --no-edit'
alias gcm='git commit -m'            # normal commit
alias gc='git commit -S -m'          # signed commit with message
alias gcse='git commit -S --allow-empty -m'

# branch & switching (use git switch)
alias gsw='git switch'
alias gcb='git switch -c'            # create & switch to new branch (was checkout -b)
alias gb='git branch'
alias gba='git branch -a'
alias gbd='git branch -D'
alias gtags='git tag -l'

# fetch / pull / push
alias gfetch='git fetch --all --prune'
alias gpl='git pull'
alias gplr='git pull --rebase'
alias gp='git push'
alias gpf='git push -f'
# safer force-with-lease push
alias gpfl='git push --force-with-lease'

# clone / remote
alias gcl='git clone'
alias gremote='git remote -v'

# stash
alias gstash='git stash push -m'
alias gstashp='git stash pop'

# undo / resets (kept distinct)
alias gundo='git reset --soft HEAD~1'      # undo last commit but keep changes (soft)
alias gundo-hard='git reset --hard HEAD~1' # destructive - undo and drop changes
alias gundo-mixed='git reset HEAD~1'       # mixed reset

# cleanup & utilities
alias gclean='git fetch --prune && git branch --merged | grep -v "\*" | xargs -n 1 git branch -D 2>/dev/null || true'
alias gcount='git rev-list --all --count'
alias gfetchprune='git fetch --prune'

# misc
alias gst='git status'   # convenience (optional duplicate)



# --- Docker Helpers ---
alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
alias dstop='docker stop $(docker ps -q)'
alias drm='docker rm -f $(docker ps -aq)'
alias dprune='docker system prune -af --volumes'
alias docker-clean='docker rm -f $(docker ps -aq) 2>/dev/null'
alias dimg='docker images'
alias dnet='docker network ls'
alias dlogs='docker logs -f'
alias dbash='docker exec -it'   # usage: dbash container-name bash

# --- NPM / PNPM ---
alias dev='npm run dev'
alias ni='npm install'
alias nr='npm run'
alias nrb='npm run build'
alias nrt='npm run test'
alias nrs='npm run start'
alias pi='pnpm install'
alias pr='pnpm run'
alias format='npm run format'
alias clean='npm run clean'
alias start='npm start'
alias od='npm outdated'
alias nuke='rm -rf node_modules package-lock.json pnpm-lock.yaml yarn.lock'
alias reinstall='nuke && npm install'
alias npmls='npm ls --depth=0'
alias nrun='npm run'
alias pm='pnpm'
alias nu='npm uninstall'   # uninstall package
alias nu-g='npm uninstall -g'   # uninstall global package
alias pui='pnpm remove'          # pnpm uninstall
alias yui='yarn remove'          # yarn uninstall   # uninstall package

# --- System ---
alias ports='sudo lsof -i -P -n | grep LISTEN'
alias update='sudo apt update && sudo apt upgrade -y'
alias please='sudo $(fc -ln -1)'   # rerun last command with sudo
alias c='clear'
alias h='history'
alias j='jobs -l'
alias myip='curl ifconfig.me'
alias pingg='ping google.com'
alias flushdns='sudo systemd-resolve --flush-caches'
alias mem='free -h'
alias cpu='lscpu'
alias temp='sensors'     # requires lm-sensors
alias clsall='clear && printf "\e[3J"'  # total scrollback clear
alias now='date +"%Y-%m-%d %H:%M:%S"'
alias today='date +"%A, %d %B %Y"'
alias pingc='ping cloudflare.com'
alias iplocal='hostname -I'
alias ports-tcp='sudo lsof -nP -iTCP -sTCP:LISTEN'

# ========================
# Functions
# ========================

# Git branch display (cached for performance)
get_git_branch() {
  local branch
  # Use git rev-parse for better performance
  branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  [[ -n $branch && $branch != "HEAD" ]] && echo "%F{green} ‚éá $branch %f"
}

# Battery status
get_battery() {
  local battery=$(acpi -b 2>/dev/null | grep -o '[0-9]\+%' | head -n 1)
  local battery_percentage=${battery%?}
  if [[ -n "$battery_percentage" ]]; then
    if [[ $battery_percentage -lt 20 ]]; then
      echo "%F{red} üîã $battery %f"
    elif [[ $battery_percentage -gt 80 ]]; then
      echo "%F{green} üîã $battery %f"
    else
      echo " üîã $battery"
    fi
  fi
}

# Node version (cached for performance)
get_node_version() {
  local node_ver
  node_ver=$(node -v 2>/dev/null)
  [[ -n $node_ver ]] && echo "%F{blue} üß† $node_ver%f"
}

# Find a process by name
pfind() {
  ps aux | grep -i "$1" | grep -v grep
}

# Kill process on a port
killport() {
  if [ -z "$1" ]; then
    echo "Usage: killport <port>"
    return 1
  fi
  # Try fuser first (Linux), fallback to lsof (macOS/Linux)
  if command -v fuser >/dev/null 2>&1; then
    fuser -k "$1"/tcp 2>/dev/null || lsof -ti:"$1" | xargs kill -9 2>/dev/null
  elif command -v lsof >/dev/null 2>&1; then
    lsof -ti:"$1" | xargs kill -9 2>/dev/null
  else
    echo "Error: Neither fuser nor lsof found"
    return 1
  fi
}

# Rename current Git branch
grename() {
  if [ -z "$1" ]; then
    echo "Usage: grename <new-branch-name>"
    return 1
  fi
  local old_branch
  old_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  if [ -z "$old_branch" ]; then
    echo "Error: Not in a git repository"
    return 1
  fi
  git branch -m "$1" || return 1
  # Only push if remote exists
  if git remote | grep -q "^origin$"; then
    git push origin -u "$1" 2>/dev/null
    git push origin --delete "$old_branch" 2>/dev/null
  fi
}

# Extract any file automatically
extract() {
  if [ -f "$1" ] ; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1" ;;
      *.tar.gz)    tar xzf "$1" ;;
      *.bz2)       bunzip2 "$1" ;;
      *.rar)       unrar x "$1" ;;
      *.gz)        gunzip "$1" ;;
      *.tar)       tar xf "$1" ;;
      *.tbz2)      tar xjf "$1" ;;
      *.tgz)       tar xzf "$1" ;;
      *.zip)       unzip "$1" ;;
      *.7z)        7z x "$1" ;;
      *)           echo "Cannot extract '$1'" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Simple HTTP server
serve() {
  port=${1:-3000}
  python3 -m http.server "$port"
}

# Find process and show tree
pstree_find() {
  pstree -p | grep -i "$1"
}

# ========================
# Prompt
# ========================
# Define base prompt first
PROMPT='%F{yellow}[%D{%I:%M %p} - %D{%A}]%f üíª %F{cyan}Praveen Singh%f %F{magenta}[üìÅ${PWD/$HOME/~}]%f$(get_git_branch)$(get_node_version)$(get_battery)  %F{green}‚û§%f '

# Add virtual env indicator if active
if [[ -n "$VIRTUAL_ENV" ]]; then
  PROMPT="%F{blue}(venv)%f $PROMPT"
fi

# ========================
# Environment Setup
# ========================
# Note: /usr/bin is usually already in PATH, avoid prepending unless necessary

# NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# PNPM
export PNPM_HOME="$HOME/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

export PATH="$HOME/.local/bin:$PATH"

# Add any user PATH additions below
# export PATH="$HOME/bin:$PATH"
