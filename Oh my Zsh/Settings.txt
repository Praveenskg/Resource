# ========================
# Terminal & Title Config
# ========================
export TERMINAL="xterm-256color"
export DISABLE_AUTO_TITLE="true"

# ========================
# History Configuration (must be before Oh My Zsh)
# ========================
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
HIST_STAMPS="yyyy-mm-dd"
setopt HIST_VERIFY              # Show command with history expansion before running
setopt SHARE_HISTORY            # Share history between sessions
setopt HIST_IGNORE_DUPS         # Don't record duplicates
setopt HIST_IGNORE_ALL_DUPS     # Delete old recorded entry if new entry is a duplicate
setopt HIST_FIND_NO_DUPS        # Do not display a line previously found
setopt HIST_IGNORE_SPACE        # Don't record commands starting with space
setopt HIST_SAVE_NO_DUPS        # Don't write duplicate entries
setopt HIST_REDUCE_BLANKS       # Remove superfluous blanks

# ========================
# Oh My Zsh Setup
# ========================
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"

# Plugins list (kept as-is). These will only be effective if Oh My Zsh and plugins are installed.
plugins=(git docker npm zsh-autosuggestions zsh-completions zsh-syntax-highlighting)

# Source Oh My Zsh if present, otherwise warn
if [ -d "$ZSH" ] && [ -f "$ZSH/oh-my-zsh.sh" ]; then
  source "$ZSH/oh-my-zsh.sh"
else
  echo "‚ö†Ô∏è  Warning: Oh My Zsh not found at $ZSH. Skipping Oh My Zsh load."
fi

# If some plugins like zsh-syntax-highlighting need to be sourced after, attempt that safely
# (common install locations)
if [ -f "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then
  # ensure it's sourced last
  source "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# Set terminal title after Oh My Zsh loads (some themes overwrite it ‚Äî this helps)
print -Pn "\e]0;üíª  Praveen Singh\a"

# ========================
# Aliases
# ========================

# --- File & Navigation ---
# Use eza (exa) if available, otherwise fall back to ls
if command -v eza >/dev/null 2>&1; then
  alias ls='eza -la --icons'
  alias ll='eza -l --icons'
  alias tree='eza --tree --icons'
else
  alias ls='ls -la'
  alias ll='ls -l'
fi

alias cls='clear'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -'    # go back to previous dir

# Editor / tools: set only if available
command -v code >/dev/null 2>&1 && alias c.='code .'
command -v cursor >/dev/null 2>&1 && alias cr='cursor .'

# bat vs batcat portability (Debian uses batcat)
if command -v batcat >/dev/null 2>&1; then
  alias bat='batcat'
elif command -v bat >/dev/null 2>&1; then
  alias bat='bat'
fi

alias md='mkdir -p'
alias rd='rm -rf'
alias f='find . -type f -name'     # usage: f "*.js"
alias d='find . -type d -name'     # usage: d "components"
alias reload='source ~/.zshrc'     # reload zsh quickly
alias ..2='cd ../../'
alias ..3='cd ../../../'
alias sz='source ~/.zshrc'
alias paths='echo $PATH | tr ":" "\n"'
alias usage='du -sh *'   # show folder sizes
alias whichp='which -a'  # show all executable paths

# --- Git Shortcuts ---
alias gs='git status'
alias gss='git status -s'
alias gl='git log --oneline --graph --decorate --all'
alias gshow='git show'
alias gdiff='git diff'
alias gstats='git diff --stat'
alias ga='git add .'
alias gau='git add -u'
alias gamend='git commit --amend --no-edit'
alias gcm='git commit -m'
alias gc='git commit -S -m'
alias gcse='git commit -S --allow-empty -m'
alias gsw='git switch'
alias gcb='git switch -c'
alias gb='git branch'
alias gba='git branch -a'
alias gbd='git branch -D'
alias gtags='git tag -l'
alias gfetch='git fetch --all --prune'
alias gpl='git pull'
alias gplr='git pull --rebase'
alias gp='git push'
alias gpf='git push -f'
alias gpfl='git push --force-with-lease'
alias gcl='git clone'
alias gremote='git remote -v'
alias gstash='git stash push -m'
alias gstashp='git stash pop'
alias gundo='git reset --soft HEAD~1'
alias gundo-hard='git reset --hard HEAD~1'
alias gundo-mixed='git reset HEAD~1'
# safer gclean: works on GNU xargs (use -r to avoid running command with empty input), fallback preserved
if xargs --help 2>&1 | grep -q -- '-r'; then
  alias gclean='git fetch --prune && git branch --merged | grep -v "\*" | xargs -r -n 1 git branch -D 2>/dev/null || true'
else
  alias gclean='git fetch --prune && git branch --merged | grep -v "\*" | xargs -n 1 git branch -D 2>/dev/null || true'
fi
alias gcount='git rev-list --all --count'
alias gfetchprune='git fetch --prune'

# --- Docker Helpers ---
alias dps='docker ps'
alias dstop='docker stop $(docker ps -q 2>/dev/null) 2>/dev/null || true'
alias drm='docker rm -f $(docker ps -aq 2>/dev/null) 2>/dev/null || true'
alias dprune='docker system prune -af --volumes'
alias docker-clean='docker rm -f $(docker ps -aq 2>/dev/null) 2>/dev/null || true'
alias dimg='docker images'
alias dnet='docker network ls'
alias dlogs='docker logs -f'
alias dbash='docker exec -it'
alias mongo-docker='echo "üê≥ Switching to Docker Mongo (27017)" && \
sudo systemctl stop mongod && \
docker compose --profile db up -d'
alias mongo-local='echo "üü¢ Switching to Local Mongo (27017)" && \
docker compose --profile db down && \
sudo systemctl start mongod'
alias mongo-check='echo "üîé Mongo on 27017:" && sudo lsof -i :27017'
alias mongo-shell='mongosh mongodb://localhost:27017'

# --- NPM / PNPM ---
alias dev='npm run dev'
alias ni='npm install'
alias nr='npm run'
alias nrb='npm run build'
alias nrt='npm run test'
alias nrs='npm run start'
alias pi='pnpm install'
alias pr='pnpm run'
alias format='npm run format'
alias clean='npm run clean'
alias start='npm start'
alias od='npm outdated'
alias nuke='rm -rf node_modules package-lock.json pnpm-lock.yaml yarn.lock'
alias reinstall='nuke && npm install'
alias npmls='npm ls --depth=0'
alias nrun='npm run'
alias pm='pnpm'
alias nu='npm uninstall'
alias nu-g='npm uninstall -g'
alias pui='pnpm remove'
alias yui='yarn remove'

# --- System ---
alias ports='sudo lsof -i -P -n | grep LISTEN'
alias update='sudo apt update && sudo apt upgrade -y'
alias please='sudo $(fc -ln -1)'
alias c='clear'
alias h='history'
alias j='jobs -l'
alias myip='curl ifconfig.me'
alias pingg='ping google.com'
alias flushdns='sudo systemd-resolve --flush-caches'
alias mem='free -h'
alias cpu='lscpu'
alias temp='sensors'
alias clsall='clear && printf "\e[3J"'
alias now='date +"%Y-%m-%d %H:%M:%S"'
alias today='date +"%A, %d %B %Y"'
alias pingc='ping cloudflare.com'
alias iplocal='hostname -I'
alias ports-tcp='sudo lsof -nP -iTCP -sTCP:LISTEN'

# ========================
# Functions
# ========================

get_git_branch() {
  local branch
  branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  [[ -n $branch && $branch != "HEAD" ]] && echo "%F{green} ‚éá $branch %f"
}

get_battery() {
  # Return nothing if acpi missing (avoids errors on desktops/VMs)
  if ! command -v acpi >/dev/null 2>&1; then
    return
  fi
  local battery
  battery=$(acpi -b 2>/dev/null | grep -o '[0-9]\+%' | head -n 1)
  local battery_percentage=${battery%?}
  if [[ -n "$battery_percentage" ]]; then
    if [[ $battery_percentage -lt 20 ]]; then
      echo "%F{red} üîã $battery %f"
    elif [[ $battery_percentage -gt 80 ]]; then
      echo "%F{green} üîã $battery %f"
    else
      echo " üîã $battery"
    fi
  fi
}

get_node_version() {
  # Avoid printing if node not available
  if command -v node >/dev/null 2>&1; then
    local node_ver
    node_ver=$(node -v 2>/dev/null)
    [[ -n $node_ver ]] && echo "%F{blue} üß† $node_ver%f"
  fi
}

pfind() {
  ps aux | grep -i "$1" | grep -v grep
}

killport() {
  if [ -z "$1" ]; then
    echo "Usage: killport <port>"
    return 1
  fi
  if command -v fuser >/dev/null 2>&1; then
    fuser -k "$1"/tcp 2>/dev/null || lsof -ti:"$1" | xargs kill -9 2>/dev/null || true
  elif command -v lsof >/dev/null 2>&1; then
    lsof -ti:"$1" | xargs kill -9 2>/dev/null || true
  else
    echo "Error: Neither fuser nor lsof found. Install with: sudo apt install psmisc lsof"
    return 1
  fi
}

grename() {
  if [ -z "$1" ]; then
    echo "Usage: grename <new-branch-name>"
    return 1
  fi
  local old_branch
  old_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  if [ -z "$old_branch" ]; then
    echo "Error: Not in a git repository"
    return 1
  fi
  git branch -m "$1" || return 1
  if git remote | grep -q "^origin$"; then
    git push origin -u "$1" 2>/dev/null
    git push origin --delete "$old_branch" 2>/dev/null || true
  fi
}

extract() {
  if [ -f "$1" ] ; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1" ;;
      *.tar.gz)    tar xzf "$1" ;;
      *.bz2)       bunzip2 "$1" ;;
      *.rar)       unrar x "$1" ;;
      *.gz)        gunzip "$1" ;;
      *.tar)       tar xf "$1" ;;
      *.tbz2)      tar xjf "$1" ;;
      *.tgz)       tar xzf "$1" ;;
      *.zip)       unzip "$1" ;;
      *.7z)        7z x "$1" ;;
      *)           echo "Cannot extract '$1'" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

serve() {
  port=${1:-3000}
  python3 -m http.server "$port"
}

pstree_find() {
  if command -v pstree >/dev/null 2>&1; then
    pstree -p | grep -i "$1"
  else
    ps aux | grep -i "$1" | grep -v grep
  fi
}

get_python_version() {
  if command -v python3 >/dev/null 2>&1; then
    local py_ver
    py_ver=$(python3 --version 2>/dev/null | awk '{print $2}')
    echo "%F{yellow} üêç $py_ver%f"
  fi
}

# ========================
# Prompt
# ========================
PROMPT='%F{yellow}[%D{%I:%M %p} - %D{%A}]%f üíª %F{cyan}Praveen Singh%f %F{magenta}[üìÅ${PWD/$HOME/~}]%f$(get_git_branch)$(get_node_version)$(get_python_version)$(get_battery)  %F{green}‚û§%f '

# ========================
# Environment Setup
# ========================
# Note: /usr/bin is usually already in PATH, avoid prepending unless necessary

# NVM
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  # shellcheck source=/dev/null
  . "$NVM_DIR/nvm.sh"
fi
if [ -s "$NVM_DIR/bash_completion" ]; then
  # shellcheck source=/dev/null
  . "$NVM_DIR/bash_completion"
fi


export PATH="$HOME/.local/bin:$PATH"

# Add any user PATH additions below
# export PATH="$HOME/bin:$PATH"

# quick syntax check helper (uncomment to run automatically on new shells if desired)
# zsh -n ~/.zshrc || echo "zshrc syntax check failed"

# ========================
# End of file
# ========================


# pnpm
export PNPM_HOME="/home/praveen-singh/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end